<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel | Faith Church</title>
    
    <!-- Favicon -->
    <link rel="icon" href="IMG_8426.png" type="image/png">

    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts: Montserrat -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;700;800&display=swap" rel="stylesheet">
    
    <!-- Quill Rich Text Editor CSS -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">

    <!-- Custom Styles & Color Configuration for Tailwind -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        // 'sans' is overridden to use Montserrat as the primary font
                        'sans': ['Montserrat', 'sans-serif'],
                    },
                    colors: {
                        // Custom color palette defined in the brand kit
                        'battleship-gray': '#7b8a83',
                        'lion': '#b99769',
                        'alabaster': '#f5f1e9',
                        'jet': '#2f2f2f',
                        'delft-blue': '#40476d',
                    }
                }
            }
        }
    </script>
    
    <style>
        /* Basic body styling to ensure consistent background and text color */
        body { 
            background-color: #f5f1e9; /* Alabaster */
            color: #2f2f2f; /* Jet */
            font-family: 'Montserrat', sans-serif; 
        }

        /* Styling for active tab button to make it visually distinct */
        .tab-btn.active { 
            border-color: #40476d; /* Delft Blue for active border */
            background-color: #40476d; /* Delft Blue background for active tab */
            color: white; /* White text for active tab */
        }

        /* Ensure tab content has a minimum height to prevent layout shifts */
        .tab-content { 
            min-height: 50vh; 
        }

        /* Hide scrollbar for tabs on mobile for a cleaner look */
        .tabs-container::-webkit-scrollbar { 
            display: none; 
        }
        .tabs-container { 
            -ms-overflow-style: none; /* IE and Edge */
            scrollbar-width: none; /* Firefox */
        }

        /* Apply consistent styling to all form input fields */
        input[type="text"],
        input[type="password"],
        input[type="email"],
        textarea {
            @apply w-full p-3 rounded-md border border-gray-300 shadow-sm focus:outline-none focus:ring-2 focus:ring-lion;
        }

        /* Apply consistent styling to all buttons */
        button {
            @apply px-6 py-3 rounded-lg font-bold transition-all duration-300;
        }

        /* Specific styling for Quill editor container */
        #editor {
            min-height: 200px; /* Ensure sufficient height for the editor */
            border-radius: 0.5rem; /* Rounded corners for the editor */
            border: 1px solid #d1d5db; /* Light gray border */
        }
        /* Adjust Quill toolbar and content for better mobile display */
        .ql-toolbar.ql-snow {
            border-top-left-radius: 0.5rem;
            border-top-right-radius: 0.5rem;
            border-color: #d1d5db;
        }
        .ql-container.ql-snow {
            border-bottom-left-radius: 0.5rem;
            border-bottom-right-radius: 0.5rem;
            border-color: #d1d5db;
        }
    </style>
</head>
<body class="bg-alabaster">

    <!-- Auth Container: Centered login/signup form -->
    <div id="auth-container" class="min-h-screen flex items-center justify-center py-8 px-4 sm:px-6 lg:px-8">
        <div class="max-w-md w-full bg-white p-6 sm:p-8 rounded-xl shadow-2xl">
            <div class="text-center mb-6 sm:mb-8">
                <img src="IMG_8426.png" alt="Faith Church Logo" class="w-16 h-16 mx-auto mb-4">
                <h1 class="text-3xl sm:text-4xl font-extrabold text-jet">Blog Admin Login</h1>
            </div>
            
            <!-- Login Form -->
            <form id="login-form" class="space-y-5">
                <div>
                    <label for="login-email" class="block text-sm font-bold text-jet mb-1">Email</label>
                    <input type="email" id="login-email" required>
                </div>
                <div>
                    <label for="login-password" class="block text-sm font-bold text-jet mb-1">Password</label>
                    <input type="password" id="login-password" required>
                </div>
                <button type="submit" class="w-full bg-delft-blue text-white hover:bg-opacity-90 py-3 px-4">Log In</button>
            </form>

            <div class="mt-4 text-center">
                <p class="text-sm text-battleship-gray">Don't have an account? <a href="#" id="show-signup" class="font-bold text-lion hover:underline">Sign Up</a></p>
            </div>

            <!-- Sign Up Form (hidden by default) -->
            <form id="signup-form" class="hidden space-y-5 mt-4">
                 <div>
                    <label for="signup-name" class="block text-sm font-bold text-jet mb-1">Full Name</label>
                    <input type="text" id="signup-name" required>
                </div>
                <div>
                    <label for="signup-email" class="block text-sm font-bold text-jet mb-1">Email</label>
                    <input type="email" id="signup-email" required>
                </div>
                <div>
                    <label for="signup-password" class="block text-sm font-bold text-jet mb-1">Password (min. 6 characters)</label>
                    <input type="password" id="signup-password" required>
                </div>
                <div>
                    <label for="admin-key" class="block text-sm font-bold text-jet mb-1">Admin Key</label>
                    <input type="password" id="admin-key" required placeholder="Enter the secret key">
                </div>
                <button type="submit" class="w-full bg-lion text-white hover:bg-opacity-90 py-3 px-4">Create Account</button>
                 <p class="text-sm text-center text-battleship-gray mt-4">Already have an account? <a href="#" id="show-login" class="font-bold text-lion hover:underline">Log In</a></p>
            </form>
            <div id="auth-feedback" class="mt-4"></div>
        </div>
    </div>

    <!-- Content Management Container (hidden by default) -->
    <div id="content-container" class="hidden">
        <header class="bg-white shadow-md">
            <div class="container mx-auto px-4 sm:px-6 py-4 flex flex-col sm:flex-row justify-between items-center">
                <h1 class="text-2xl sm:text-3xl font-extrabold text-jet mb-2 sm:mb-0">Admin Panel</h1>
                <div class="flex flex-col sm:flex-row items-center space-y-2 sm:space-y-0 sm:space-x-4">
                    <span id="user-email" class="text-sm text-battleship-gray"></span>
                    <button id="logout-button" class="bg-delft-blue text-white py-2 px-4 hover:bg-opacity-90">Log Out</button>
                </div>
            </div>
        </header>

        <main class="container mx-auto p-4 sm:p-6 lg:p-8">
            <!-- Tabs -->
            <div class="mb-8 border-b border-gray-300">
                <nav class="tabs-container flex space-x-2 sm:space-x-4 overflow-x-auto pb-2" aria-label="Tabs">
                    <button class="tab-btn active flex-shrink-0 font-bold py-2 px-3 sm:px-4 border-b-2" data-tab="blog">Blog Posts</button>
                    <button class="tab-btn flex-shrink-0 font-bold py-2 px-3 sm:px-4 border-b-2 border-transparent" data-tab="contact">Contact Messages</button>
                    <button class="tab-btn flex-shrink-0 font-bold py-2 px-3 sm:px-4 border-b-2 border-transparent" data-tab="prayer">Prayer Requests</button>
                </nav>
            </div>

            <!-- Tab Content -->
            <div id="blog-tab" class="tab-content">
                <section class="bg-white p-6 md:p-8 rounded-xl shadow-lg mb-12">
                    <h2 class="text-2xl sm:text-3xl font-extrabold text-jet mb-6">Create New Post</h2>
                    <form id="post-form">
                        <div class="mb-4">
                            <label for="post-title" class="block text-base sm:text-lg font-bold text-jet mb-2">Post Title</label>
                            <input type="text" id="post-title" required>
                        </div>
                        <div class="mb-6">
                            <label class="block text-base sm:text-lg font-bold text-jet mb-2">Post Content</label>
                            <div id="editor" class="bg-white"></div>
                        </div>
                        <button type="submit" id="publish-button" class="bg-lion text-white hover:bg-opacity-90 py-3 px-4">Publish Post</button>
                    </form>
                    <div id="form-feedback" class="mt-4"></div>
                </section>
                <section>
                    <h2 class="text-2xl sm:text-3xl font-extrabold text-jet mb-6">Manage Existing Posts</h2>
                    <div id="manage-posts-container" class="space-y-4"></div>
                </section>
            </div>

            <div id="contact-tab" class="tab-content hidden">
                <h2 class="text-2xl sm:text-3xl font-extrabold text-jet mb-6">Contact Form Submissions</h2>
                <div id="contact-submissions-container" class="space-y-4"></div>
            </div>

            <div id="prayer-tab" class="tab-content hidden">
                <h2 class="text-2xl sm:text-3xl font-extrabold text-jet mb-6">Prayer Requests</h2>
                <div id="prayer-requests-container" class="space-y-4"></div>
            </div>
        </main>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-firestore.js"></script>
    
    <!-- Quill Rich Text Editor JS -->
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>

    <script>
        // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyBomHYAHPdSq4K2YrngzOnPRv71r-Otvcw",
            authDomain: "faith-church-website-fdbdf.firebaseapp.com",
            projectId: "faith-church-website-fdbdf",
            storageBucket: "faith-church-website-fdbdf.appspot.com",
            messagingSenderId: "303139000318",
            appId: "1:303139000318:web:68efb84508d6be04a5baaf",
            measurementId: "G-CVRKCE2EJZ"
        };

        // --- Initialize Firebase ---
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const auth = firebase.auth();
        const db = firebase.firestore();

        // --- Initialize Quill Editor ---
        const quill = new Quill('#editor', {
            theme: 'snow',
            modules: { toolbar: [[{ 'header': [1, 2, false] }], ['bold', 'italic', 'underline'], [{'list': 'ordered'}, {'list': 'bullet'}], ['link'], ['clean']] }
        });

        // --- UI Element References ---
        const authContainer = document.getElementById('auth-container');
        const contentContainer = document.getElementById('content-container');
        const loginForm = document.getElementById('login-form');
        const signupForm = document.getElementById('signup-form');
        const userEmailSpan = document.getElementById('user-email');
        const authFeedbackDiv = document.getElementById('auth-feedback');
        const formFeedbackDiv = document.getElementById('form-feedback');
        const tabs = document.querySelectorAll('.tab-btn');
        const tabContents = document.querySelectorAll('.tab-content');

        // --- Auth State Listener ---
        auth.onAuthStateChanged(user => {
            if (user) {
                authContainer.classList.add('hidden');
                contentContainer.classList.remove('hidden');
                userEmailSpan.textContent = user.displayName || user.email;
                loadInitialData();
            } else {
                authContainer.classList.remove('hidden');
                contentContainer.classList.add('hidden');
            }
        });
        
        // --- Tab Functionality ---
        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                tabs.forEach(item => item.classList.remove('active'));
                tab.classList.add('active');
                
                const target = tab.getAttribute('data-tab');
                tabContents.forEach(content => {
                    if (content.id === `${target}-tab`) {
                        content.classList.remove('hidden');
                    } else {
                        content.classList.add('hidden');
                    }
                });
            });
        });

        // --- Auth Form Toggling ---
        document.getElementById('show-signup').addEventListener('click', (e) => {
            e.preventDefault();
            loginForm.classList.add('hidden');
            loginForm.parentElement.querySelector('.mt-4').classList.add('hidden');
            signupForm.classList.remove('hidden');
            authFeedbackDiv.innerHTML = '';
        });
        document.getElementById('show-login').addEventListener('click', (e) => {
            e.preventDefault();
            signupForm.classList.add('hidden');
            loginForm.classList.remove('hidden');
            loginForm.parentElement.querySelector('.mt-4').classList.remove('hidden');
            authFeedbackDiv.innerHTML = '';
        });

        // --- Error Handling ---
        function showAuthError(message) {
            authFeedbackDiv.innerHTML = `<div class="p-3 rounded-md bg-red-100 text-red-800 text-center">${message}</div>`;
        }
        
        function showFormFeedback(message, type) {
            const color = type === 'success' ? 'green' : 'red';
            formFeedbackDiv.innerHTML = `<div class="p-3 rounded-md bg-${color}-100 text-${color}-800">${message}</div>`;
            setTimeout(() => {
                formFeedbackDiv.innerHTML = '';
            }, 4000);
        }

        // --- Auth Event Handlers ---
        signupForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const name = document.getElementById('signup-name').value;
            const email = document.getElementById('signup-email').value;
            const password = document.getElementById('signup-password').value;
            const adminKey = document.getElementById('admin-key').value;
            
            if (adminKey !== 'Faith1017!') {
                showAuthError('Invalid Admin Key.');
                return;
            }

            auth.createUserWithEmailAndPassword(email, password)
                .then(userCredential => {
                    return userCredential.user.updateProfile({
                        displayName: name
                    });
                })
                .catch(error => {
                    let friendlyError = "An unknown error occurred.";
                    if (error.code === 'auth/email-already-in-use') {
                        friendlyError = 'An account with this email already exists.';
                    } else if (error.code === 'auth/weak-password') {
                        friendlyError = 'Password should be at least 6 characters.';
                    }
                    showAuthError(friendlyError);
                });
        });

        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            auth.signInWithEmailAndPassword(email, password).catch(error => {
                showAuthError('Invalid email or password.');
            });
        });

        document.getElementById('logout-button').addEventListener('click', () => auth.signOut());

        // --- Data Loading ---
        function loadInitialData() {
            fetchPosts();
            fetchContactSubmissions();
            fetchPrayerRequests();
        }

        // --- Firestore Handlers ---
        document.getElementById('post-form').addEventListener('submit', e => {
            e.preventDefault();
            const title = document.getElementById('post-title').value;
            const content = quill.root.innerHTML;
            const user = auth.currentUser;

            if (!title || content === '<p><br></p>') {
                showFormFeedback('Title and content cannot be empty.', 'error');
                return;
            }

            db.collection('posts').add({
                title: title,
                content: content,
                author: user.displayName || user.email,
                authorId: user.uid,
                date: firebase.firestore.FieldValue.serverTimestamp()
            })
            .then(() => {
                showFormFeedback('Post published successfully!', 'success');
                document.getElementById('post-form').reset();
                quill.setText('');
                fetchPosts();
            })
            .catch(error => {
                showFormFeedback('Error publishing post: ' + error.message, 'error');
            });
        });

        async function fetchPosts() {
            const container = document.getElementById('manage-posts-container');
            container.innerHTML = '<p class="text-battleship-gray">Loading posts...</p>';
            const snapshot = await db.collection("posts").orderBy("date", "desc").get();
            
            if (snapshot.empty) {
                container.innerHTML = '<p class="text-battleship-gray">No posts found.</p>';
                return;
            }
            
            container.innerHTML = '';
            snapshot.forEach(doc => {
                const post = doc.data();
                const postEl = document.createElement('div');
                postEl.className = 'flex flex-col sm:flex-row justify-between items-start sm:items-center bg-gray-100 p-4 rounded-lg';
                const postDate = post.date ? post.date.toDate().toLocaleDateString() : 'Just now';
                postEl.innerHTML = `
                    <div class="mb-2 sm:mb-0">
                        <h4 class="font-bold text-jet">${post.title}</h4>
                        <p class="text-sm text-battleship-gray">By ${post.author} on ${postDate}</p>
                    </div>
                    <button data-id="${doc.id}" data-collection="posts" class="delete-btn bg-red-600 text-white text-sm font-bold py-2 px-3 rounded-lg hover:bg-red-700">Delete</button>
                `;
                container.appendChild(postEl);
            });
        }
        
        async function fetchContactSubmissions() {
            const container = document.getElementById('contact-submissions-container');
            container.innerHTML = '<p class="text-battleship-gray">Loading messages...</p>';
            const snapshot = await db.collection("contactSubmissions").orderBy("timestamp", "desc").get();
            if (snapshot.empty) {
                container.innerHTML = '<p class="text-battleship-gray">No contact messages found.</p>';
                return;
            }
            container.innerHTML = '';
            snapshot.forEach(doc => {
                container.appendChild(createSubmissionCard(doc, 'contactSubmissions'));
            });
        }

        async function fetchPrayerRequests() {
            const container = document.getElementById('prayer-requests-container');
            container.innerHTML = '<p class="text-battleship-gray">Loading prayer requests...</p>';
            const snapshot = await db.collection("prayerRequests").orderBy("timestamp", "desc").get();
            if (snapshot.empty) {
                container.innerHTML = '<p class="text-battleship-gray">No prayer requests found.</p>';
                return;
            }
            container.innerHTML = '';
            snapshot.forEach(doc => {
                container.appendChild(createSubmissionCard(doc, 'prayerRequests'));
            });
        }

        function createSubmissionCard(doc, collectionName) {
            const data = doc.data();
            const card = document.createElement('div');
            card.className = 'bg-gray-100 p-4 rounded-lg shadow';
            const date = data.timestamp ? data.timestamp.toDate().toLocaleString() : 'N/A';
            
            let contentHtml = `
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center">
                    <div>
                        <p class="text-sm text-battleship-gray">${date}</p>
                        <p class="font-bold text-jet">From: ${data.name || 'Anonymous'} (${data.email || 'No Email'})</p>
                    </div>
                    <button data-id="${doc.id}" data-collection="${collectionName}" class="delete-btn bg-red-600 text-white text-xs font-bold py-1 px-2 rounded hover:bg-red-700 mt-2 sm:mt-0">&times;</button>
                </div>
                <div class="mt-2 p-2 bg-white rounded">
                    ${data.privacy ? `<p class="font-bold text-delft-blue mb-1">${data.privacy}</p>` : ''}
                    <p class="whitespace-pre-wrap text-jet">${data.message || data.request}</p>
                </div>
            `;
            card.innerHTML = contentHtml;
            return card;
        }

        // Universal delete listener
        document.getElementById('content-container').addEventListener('click', e => {
            if (e.target.classList.contains('delete-btn')) {
                const id = e.target.dataset.id;
                const collection = e.target.dataset.collection;
                // Using a custom modal/confirmation instead of alert/confirm
                showCustomConfirm(`Are you sure you want to delete this item?`, () => {
                    db.collection(collection).doc(id).delete().then(() => {
                        if (collection === 'posts') fetchPosts();
                        if (collection === 'contactSubmissions') fetchContactSubmissions();
                        if (collection === 'prayerRequests') fetchPrayerRequests();
                    }).catch(error => {
                        console.error("Error deleting document: ", error);
                        showFormFeedback("Error deleting item.", "error");
                    });
                });
            }
        });

        // Custom confirmation modal (replaces alert/confirm)
        function showCustomConfirm(message, onConfirm) {
            const modalHtml = `
                <div id="custom-confirm-modal" class="fixed inset-0 bg-jet bg-opacity-50 flex items-center justify-center z-50 p-4">
                    <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm text-center">
                        <p class="text-lg font-semibold text-jet mb-6">${message}</p>
                        <div class="flex justify-center space-x-4">
                            <button id="confirm-yes" class="bg-red-600 text-white py-2 px-5 rounded-lg hover:bg-red-700 transition-colors duration-200">Yes</button>
                            <button id="confirm-no" class="bg-battleship-gray text-white py-2 px-5 rounded-lg hover:bg-gray-600 transition-colors duration-200">No</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHtml);

            document.getElementById('confirm-yes').addEventListener('click', () => {
                onConfirm();
                document.getElementById('custom-confirm-modal').remove();
            });
            document.getElementById('confirm-no').addEventListener('click', () => {
                document.getElementById('custom-confirm-modal').remove();
            });
        }

    </script>
</body>

</html>
